  <div id="invoice-screen" class="screen">
    <div class="header">
      <button class="back-btn" onclick="showScreen('home')" title="ホームに戻る">🏠</button>
      <h1>📄 請求書作成</h1>
      <div style="width: 40px;"></div>
    </div>
    
    <div class="form-container">
      <!-- 見積書から作成 -->
      <div class="form-section" style="background: linear-gradient(135deg, #fef3c7, #fde68a);">
        <button class="add-item-btn" style="background: white; border: 2px solid #f59e0b; color: #d97706;" onclick="showEstimatePicker()">
          📝 見積書から作成する
        </button>
      </div>
      
      <!-- 基本情報 -->
      <div class="form-section">
        <h2>■ 基本情報</h2>
        <div class="form-group">
          <label>お客様名</label>
          <div style="display: flex; gap: 8px;">
            <input type="text" id="invCustomerName" placeholder="〇〇 様" style="flex: 1;">
            <button class="voice-input-btn" onclick="startVoiceInput('invCustomerName')" title="音声入力">🎤</button>
            <button class="master-btn edit" style="white-space: nowrap; padding: 8px 12px;" onclick="showCustomerPicker(selectCustomerForInvoice)">👤 選択</button>
          </div>
        </div>
        <div class="form-group" id="invCustomerAddressGroup" style="display: none;">
          <label>お客様住所</label>
          <input type="text" id="invCustomerAddress" placeholder="住所" readonly style="background: #f9fafb;">
        </div>
        <div class="form-group">
          <label>件名</label>
          <div style="display: flex; gap: 8px;">
            <input type="text" id="invSubject" placeholder="浴室水栓交換工事" style="flex: 1;">
            <button class="voice-input-btn" onclick="startVoiceInput('invSubject')" title="音声入力">🎤</button>
          </div>
        </div>
        <div class="form-group">
          <label>請求日</label>
          <input type="date" id="invDate">
        </div>
        <div class="form-group">
          <label>お支払期限</label>
          <input type="date" id="invDueDate">
        </div>
      </div>
      
      <!-- 材料費 -->
      <div class="form-section">
        <h2>■ 材料費</h2>
        <div id="invMaterialsList">
          <!-- 材料がここに追加される -->
        </div>
        <div style="display: flex; gap: 8px;">
          <button class="add-item-btn" style="flex: 1;" onclick="addInvoiceMaterial()">
            ＋ 材料を追加
          </button>
          <button class="add-item-btn" style="flex: 1; background: #eff6ff; border-color: #3b82f6; color: #3b82f6;" onclick="showInvMaterialPicker()">
            📦 マスターから選択
          </button>
        </div>
        <div class="subtotal-row">
          <span>材料費 小計:</span>
          <span id="invMaterialSubtotal">¥0</span>
        </div>
      </div>
      
      <!-- 作業費 -->
      <div class="form-section">
        <h2>■ 作業費</h2>
        <div class="form-group">
          <label>計算方法</label>
          <div class="type-btn-group">
            <button class="type-btn active" id="invWorkTypeConstruction" onclick="setInvWorkType('construction')">施工費</button>
            <button class="type-btn" id="invWorkTypeDaily" onclick="setInvWorkType('daily')">日当</button>
          </div>
        </div>
        
        <div id="invWorksList">
          <!-- 作業がここに追加される -->
        </div>
        <button class="add-item-btn" onclick="addInvoiceWork()">
          ＋ 作業を追加
        </button>
        <div class="subtotal-row">
          <span>作業費 小計:</span>
          <span id="invWorkSubtotal">¥0</span>
        </div>
      </div>
      
      <!-- 振込先情報 -->
      <div class="form-section">
        <h2>■ 振込先</h2>
        <div id="invBankInfo" style="background: #f9fafb; padding: 12px; border-radius: 8px; font-size: 14px;">
          <!-- 設定から自動表示 -->
        </div>
        <div style="font-size: 12px; color: #6b7280; margin-top: 8px;">
          ※設定画面で振込先情報を変更できます
        </div>
      </div>
      
      <!-- 備考 -->
      <div class="form-section">
        <h2>■ 備考</h2>
        <textarea id="invNotes" rows="3" placeholder="お支払いは上記口座へお振込みください&#10;振込手数料はお客様負担でお願いいたします" style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 16px; resize: vertical;"></textarea>
      </div>
      
      <!-- 合計 -->
      <div class="form-section" style="background: linear-gradient(135deg, #eff6ff, #dbeafe);">
        <div class="total-display">
          <div class="total-row">
            <span>小計</span>
            <span id="invSubtotalDisplay">¥0</span>
          </div>
          <div class="total-row">
            <span>消費税（<span id="invTaxRateDisplay">10</span>%）</span>
            <span id="invTaxDisplay">¥0</span>
          </div>
          <div class="total-row grand-total">
            <span>ご請求金額</span>
            <span id="invTotalDisplay">¥0</span>
          </div>
        </div>
      </div>
    </div>
    
    <!-- 下部ボタン -->
    <div class="save-bar" style="display: flex; gap: 8px;">
      <button class="save-btn" style="flex: 1; background: #6b7280;" onclick="saveInvoiceDraft()">下書き保存</button>
      <button class="save-btn" style="flex: 2;" onclick="showInvoiceOutput()">出力 →</button>
    </div>
  </div>
  
  <!-- 見積書選択モーダル -->
  <div id="estimatePickerModal" class="ocr-loading hidden" style="background: rgba(0,0,0,0.5);">
    <div style="background: white; border-radius: 16px; width: 90%; max-width: 400px; max-height: 80vh; display: flex; flex-direction: column;">
      <div style="padding: 16px; border-bottom: 1px solid #e5e7eb;">
        <h3 style="margin: 0; font-size: 18px;">📝 見積書から選択</h3>
      </div>
      <div id="estimatePickerList" style="flex: 1; overflow-y: auto; padding: 12px;">
        <!-- 見積書リスト -->
      </div>
      <div style="padding: 12px; border-top: 1px solid #e5e7eb;">
        <button class="data-btn backup" style="width: 100%;" onclick="closeEstimatePicker()">閉じる</button>
      </div>
    </div>
  </div>
  
  <!-- 請求書材料選択モーダル -->
  <div id="invMaterialPickerModal" class="ocr-loading hidden" style="background: rgba(0,0,0,0.5);">
    <div style="background: white; border-radius: 16px; width: 90%; max-width: 400px; max-height: 80vh; display: flex; flex-direction: column;">
      <div style="padding: 16px; border-bottom: 1px solid #e5e7eb;">
        <h3 style="margin: 0; font-size: 18px;">📦 品名マスターから選択</h3>
      </div>
      <div style="padding: 12px; border-bottom: 1px solid #e5e7eb;">
        <input type="text" id="invMaterialPickerSearch" placeholder="🔍 検索..." oninput="filterInvMaterialPicker()" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px;">
      </div>
      <div id="invMaterialPickerList" style="flex: 1; overflow-y: auto; padding: 12px;">
        <!-- 品名リスト -->
      </div>
      <div style="padding: 12px; border-top: 1px solid #e5e7eb;">
        <button class="data-btn backup" style="width: 100%;" onclick="closeInvMaterialPicker()">閉じる</button>
      </div>
    </div>
  </div>
  
  <!-- 請求書出力モーダル -->
  <div id="invOutputModal" class="ocr-loading hidden" style="background: rgba(0,0,0,0.5);">
    <div style="background: white; border-radius: 16px; padding: 20px; width: 90%; max-width: 400px;">
      <h3 style="margin: 0 0 16px 0; font-size: 18px;">📤 出力形式を選択</h3>
      
      <div id="invOutputSummary" style="background: #f3f4f6; padding: 12px; border-radius: 8px; margin-bottom: 16px; font-size: 14px;">
        <!-- 請求書概要 -->
      </div>
      
      <div style="font-size: 12px; color: #6b7280; margin-bottom: 8px; font-weight: 500;">📄 PDF</div>
      <div style="display: flex; gap: 8px; margin-bottom: 16px;">
        <button class="output-btn-mini" onclick="exportInvoicePDF('download')">
          <span>💾</span>
          <span>保存</span>
        </button>
        <button class="output-btn-mini" onclick="exportInvoicePDF('print')">
          <span>🖨️</span>
          <span>印刷</span>
        </button>
        <button class="output-btn-mini" onclick="exportInvoicePDF('share')">
          <span>📤</span>
          <span>共有</span>
        </button>
      </div>
      
      <div style="font-size: 12px; color: #6b7280; margin-bottom: 8px; font-weight: 500;">📊 Excel</div>
      <div style="display: flex; gap: 8px; margin-bottom: 16px;">
        <button class="output-btn-mini" onclick="exportInvoiceExcel()">
          <span>💾</span>
          <span>保存</span>
        </button>
      </div>
      
      <button class="data-btn backup" style="width: 100%; margin-top: 8px;" onclick="closeInvOutputModal()">キャンセル</button>
    </div>
  </div>

