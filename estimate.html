  <div id="estimate-screen" class="screen">
    <div class="header">
      <button class="back-btn" onclick="showScreen('home')" title="ホームに戻る">🏠</button>
      <h1>📝 見積書作成</h1>
      <div style="width: 40px;"></div>
    </div>
    
    <div class="form-container">
      <!-- 音声で一括作成ボタン - COCOMIカラー -->
      <div style="background: linear-gradient(135deg, #001520, #002530); border: 2px solid #00d4ff; border-radius: 12px; padding: 16px; margin-bottom: 16px; text-align: center; box-shadow: 0 0 20px rgba(0, 212, 255, 0.2), inset 0 0 30px rgba(0, 212, 255, 0.05);">
        <button onclick="startVoiceEstimate()" style="background: linear-gradient(135deg, #002a2a, #003a3a); color: #00d4ff; border: 2px solid #00d4ff; padding: 12px 24px; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 8px; margin: 0 auto; text-shadow: 0 0 10px #00d4ff; box-shadow: 0 0 15px rgba(0, 212, 255, 0.3);">
          🎤 音声で見積書を作成
        </button>
        <div style="color: #00d4ff; font-size: 11px; margin-top: 8px; opacity: 0.8; text-shadow: 0 0 5px rgba(0, 212, 255, 0.5);">例：「山田工務店さん、トイレ交換、15万円」</div>
      </div>
      
      <!-- 基本情報 -->
      <div class="form-section">
        <h2>■ 基本情報</h2>
        <div class="form-group">
          <label>お客様名</label>
          <div style="display: flex; gap: 8px;">
            <input type="text" id="estCustomerName" placeholder="〇〇 様" style="flex: 1;">
            <button class="voice-input-btn" onclick="startVoiceInput('estCustomerName')" title="音声入力">🎤</button>
            <button class="master-btn edit" style="white-space: nowrap; padding: 8px 12px;" onclick="showCustomerPicker(selectCustomerForEstimate)">👤 選択</button>
          </div>
        </div>
        <div class="form-group" id="estCustomerAddressGroup" style="display: none;">
          <label>お客様住所</label>
          <input type="text" id="estCustomerAddress" placeholder="住所" readonly style="background: #f9fafb;">
        </div>
        <div class="form-group">
          <label>件名</label>
          <div style="display: flex; gap: 8px;">
            <input type="text" id="estSubject" placeholder="浴室水栓交換工事" style="flex: 1;">
            <button class="voice-input-btn" onclick="startVoiceInput('estSubject')" title="音声入力">🎤</button>
          </div>
        </div>
        <div class="form-group">
          <label>見積日</label>
          <input type="date" id="estDate">
        </div>
        <div class="form-group">
          <label>有効期限</label>
          <input type="date" id="estValidDate">
        </div>
      </div>
      
      <!-- 材料費 -->
      <div class="form-section">
        <h2>■ 材料費</h2>
        
        <!-- 利益率一括設定 -->
        <div style="background: #fef3c7; border: 1px solid #fcd34d; border-radius: 8px; padding: 12px; margin-bottom: 12px;">
          <div style="font-size: 12px; color: #92400e; margin-bottom: 8px;">💰 利益率設定</div>
          <div style="display: flex; gap: 8px; align-items: center;">
            <span style="font-size: 14px;">一括:</span>
            <input type="number" id="estBulkProfitRate" value="20" min="0" max="100" style="width: 70px; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; text-align: center;">
            <span style="font-size: 14px;">%</span>
            <button class="master-btn edit" style="padding: 8px 12px;" onclick="applyBulkProfitRate()">全品目に適用</button>
          </div>
        </div>
        
        <div id="estMaterialsList">
          <!-- 材料がここに追加される -->
        </div>
        <div style="display: flex; gap: 8px;">
          <button class="add-item-btn" style="flex: 1;" onclick="addEstimateMaterial()">
            ＋ 材料を追加
          </button>
          <button class="add-item-btn" style="flex: 1; background: #eff6ff; border-color: #3b82f6; color: #3b82f6;" onclick="showMaterialPicker()">
            📦 マスターから選択
          </button>
        </div>
        <div style="display: flex; gap: 8px; margin-top: 8px;">
          <button class="add-item-btn" style="flex: 1; background: #fef3c7; border-color: #f59e0b; color: #d97706;" onclick="showSavedMaterialsPicker()">
            📷 レシートから取り込む
          </button>
          <button class="add-item-btn" style="flex: 1; background: #ecfdf5; border-color: #10b981; color: #059669;" onclick="showNetProductPicker()">
            🌐 ネット商品を追加
          </button>
        </div>
        <div class="subtotal-row">
          <span>材料費 小計（税抜売値）:</span>
          <span id="estMaterialSubtotal">¥0</span>
        </div>
        <div style="font-size: 12px; color: #6b7280; text-align: right;">
          （原価合計: <span id="estMaterialCost">¥0</span> / 利益: <span id="estMaterialProfit">¥0</span>）
        </div>
      </div>
      
      <!-- 作業費 -->
      <div class="form-section">
        <h2>■ 作業費</h2>
        <div class="form-group">
          <label>計算方法</label>
          <div class="type-btn-group">
            <button class="type-btn active" id="workTypeConstruction" onclick="setWorkType('construction')">施工費</button>
            <button class="type-btn" id="workTypeDaily" onclick="setWorkType('daily')">日当</button>
          </div>
        </div>
        
        <div id="estWorksList">
          <!-- 作業がここに追加される -->
        </div>
        <button class="add-item-btn" onclick="addEstimateWork()">
          ＋ 作業を追加
        </button>
        <div class="subtotal-row">
          <span>作業費 小計:</span>
          <span id="estWorkSubtotal">¥0</span>
        </div>
      </div>
      
      <!-- 備考 -->
      <div class="form-section">
        <h2>■ 備考</h2>
        <textarea id="estNotes" rows="3" placeholder="工事時間は約2時間を予定しております&#10;既存水栓の処分費を含みます" style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 16px; resize: vertical;"></textarea>
      </div>
      
      <!-- 合計 -->
      <div class="form-section" style="background: linear-gradient(135deg, #eff6ff, #dbeafe);">
        <div class="total-display">
          <div class="total-row">
            <span>小計</span>
            <span id="estSubtotalDisplay">¥0</span>
          </div>
          <div class="total-row">
            <span>消費税（<span id="estTaxRateDisplay">10</span>%）</span>
            <span id="estTaxDisplay">¥0</span>
          </div>
          <div class="total-row grand-total">
            <span>合計</span>
            <span id="estTotalDisplay">¥0</span>
          </div>
        </div>
      </div>
    </div>
    
    <!-- 下部ボタン -->
    <div class="save-bar" style="display: flex; gap: 8px;">
      <button class="save-btn" style="flex: 1; background: #6b7280;" onclick="saveEstimateDraft()">下書き保存</button>
      <button class="save-btn" style="flex: 2;" onclick="showEstimateOutput()">出力 →</button>
    </div>
  </div>
  
  <!-- 材料選択モーダル -->
  <div id="materialPickerModal" class="ocr-loading hidden" style="background: rgba(0,0,0,0.5);">
    <div style="background: white; border-radius: 16px; width: 95%; max-width: 420px; max-height: 85vh; display: flex; flex-direction: column;">
      <div style="padding: 16px; border-bottom: 1px solid #e5e7eb;">
        <h3 style="margin: 0; font-size: 18px;">📦 品名マスターから選択</h3>
        <div style="font-size: 12px; color: #6b7280; margin-top: 4px;">カテゴリを選択 → 種類 → サイズ</div>
      </div>
      
      <!-- パンくずナビ -->
      <div id="materialBreadcrumb" style="padding: 8px 12px; background: #f3f4f6; font-size: 12px; display: flex; align-items: center; gap: 4px; flex-wrap: wrap;">
        <span onclick="showMaterialCategory()" style="color: #3b82f6; cursor: pointer;">🏠 全カテゴリ</span>
      </div>
      
      <!-- 検索 -->
      <div style="padding: 12px; border-bottom: 1px solid #e5e7eb;">
        <input type="text" id="materialPickerSearch" placeholder="🔍 商品名を直接検索..." oninput="filterMaterialPicker()" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; box-sizing: border-box;">
      </div>
      
      <!-- リスト -->
      <div id="materialPickerList" style="flex: 1; overflow-y: auto; padding: 8px;">
        <!-- 階層的リスト -->
      </div>
      
      <div style="padding: 12px; border-top: 1px solid #e5e7eb;">
        <button class="data-btn backup" style="width: 100%;" onclick="closeMaterialPicker()">閉じる</button>
      </div>
    </div>
  </div>
  
  <!-- レシート材料選択モーダル -->
  <div id="savedMaterialsPickerModal" class="ocr-loading hidden" style="background: rgba(0,0,0,0.5);">
    <div style="background: white; border-radius: 16px; width: 90%; max-width: 400px; max-height: 80vh; display: flex; flex-direction: column;">
      <div style="padding: 16px; border-bottom: 1px solid #e5e7eb;">
        <h3 style="margin: 0; font-size: 18px;">📷 レシートから取り込む</h3>
        <div style="font-size: 12px; color: #6b7280; margin-top: 4px;">チェックした材料を見積書に追加します</div>
      </div>
      <div style="padding: 12px; border-bottom: 1px solid #e5e7eb;">
        <div style="display: flex; gap: 8px; align-items: center;">
          <input type="text" id="savedMaterialsSearch" placeholder="🔍 検索..." oninput="filterSavedMaterialsPicker()" style="flex: 1; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px;">
          <button class="master-btn edit" style="padding: 10px; white-space: nowrap;" onclick="toggleAllSavedMaterials()">全選択</button>
        </div>
      </div>
      <div id="savedMaterialsPickerList" style="flex: 1; overflow-y: auto; padding: 12px;">
        <!-- 保存材料リスト -->
      </div>
      <div style="padding: 12px; border-top: 1px solid #e5e7eb;">
        <div id="savedMaterialsSelectedCount" style="font-size: 14px; color: #3b82f6; margin-bottom: 8px; text-align: center;">0件選択中</div>
        <div style="display: flex; gap: 8px;">
          <button class="data-btn backup" style="flex: 1;" onclick="closeSavedMaterialsPicker()">キャンセル</button>
          <button class="save-btn" style="flex: 1; padding: 12px;" onclick="addSelectedMaterialsToEstimate()">追加する</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- ネット商品追加モーダル -->
  <div id="netProductPickerModal" class="ocr-loading hidden" style="background: rgba(0,0,0,0.5);">
    <div style="background: white; border-radius: 16px; width: 90%; max-width: 400px; max-height: 90vh; display: flex; flex-direction: column;">
      <div style="padding: 16px; border-bottom: 1px solid #e5e7eb;">
        <h3 style="margin: 0; font-size: 18px;">🌐 ネット商品を追加</h3>
        <div style="font-size: 12px; color: #6b7280; margin-top: 4px;">Amazon、モノタロウなどの商品を追加</div>
      </div>
      
      <div style="flex: 1; overflow-y: auto; padding: 16px;">
        <!-- 方法1: スクショから読み取り -->
        <div style="background: #ecfdf5; border: 1px solid #10b981; border-radius: 12px; padding: 12px; margin-bottom: 16px;">
          <div style="font-weight: 500; color: #059669; margin-bottom: 8px;">📷 スクショから読み取り</div>
          <div style="font-size: 12px; color: #6b7280; margin-bottom: 12px;">商品ページのスクリーンショットをAIが読み取ります<br>（複数枚OK！自動で結合されます）</div>
          
          <input type="file" id="netProductImage" accept="image/*" style="display: none;" onchange="handleNetProductImage(event)">
          <input type="file" id="netProductAddImage" accept="image/*" style="display: none;" onchange="handleNetProductAddImage(event)">
          
          <!-- 単一画像プレビュー -->
          <div id="netProductImageArea" onclick="document.getElementById('netProductImage').click()" style="border: 2px dashed #10b981; border-radius: 8px; padding: 20px; text-align: center; cursor: pointer; background: white;">
            <div id="netProductImagePlaceholder">
              <div style="font-size: 32px;">📱</div>
              <div style="font-size: 14px; color: #6b7280; margin-top: 8px;">タップしてスクショを選択</div>
            </div>
            <img id="netProductImagePreview" style="max-width: 100%; max-height: 150px; display: none; border-radius: 8px;">
          </div>
          
          <!-- 複数画像サムネイルエリア -->
          <div id="netProductMultiImageArea" style="display: none; margin-top: 12px;">
            <div style="font-size: 12px; color: #6b7280; margin-bottom: 8px;">📸 選択した画像（×で削除）</div>
            <div id="netProductThumbnails" style="display: flex; gap: 8px; flex-wrap: wrap; align-items: center;"></div>
          </div>
          
          <!-- ボタン群 -->
          <div style="display: flex; gap: 8px; margin-top: 12px;">
            <button class="add-item-btn" style="flex: 1; background: white; border-color: #10b981; color: #10b981;" onclick="document.getElementById('netProductAddImage').click()">
              ＋ 追加
            </button>
            <button class="add-item-btn" style="flex: 1; background: white; border-color: #ef4444; color: #ef4444;" onclick="clearNetProductImages()">
              🗑️ クリア
            </button>
          </div>
          
          <button id="netProductAiBtn" class="add-item-btn" style="margin-top: 12px; background: #10b981; border-color: #10b981; color: white;" onclick="readNetProductImage()" disabled>
            🤖 AIで読み取る
          </button>
        </div>
        
        <!-- 方法2: 手動入力 -->
        <div style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 12px; padding: 12px;">
          <div style="font-weight: 500; color: #374151; margin-bottom: 8px;">✏️ 手動で入力</div>
          
          <div style="margin-bottom: 12px;">
            <label style="font-size: 12px; color: #6b7280;">商品名 *</label>
            <input type="text" id="netProductName" placeholder="例: 塩ビパイプ VP25 2m" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; margin-top: 4px;">
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
            <div>
              <label style="font-size: 12px; color: #6b7280;">価格（税込）*</label>
              <div style="display: flex; align-items: center; margin-top: 4px;">
                <span style="padding: 10px; background: #f3f4f6; border: 1px solid #d1d5db; border-right: none; border-radius: 8px 0 0 8px;">¥</span>
                <input type="number" id="netProductPrice" placeholder="0" style="flex: 1; padding: 10px; border: 1px solid #d1d5db; border-radius: 0 8px 8px 0;">
              </div>
            </div>
            <div>
              <label style="font-size: 12px; color: #6b7280;">数量</label>
              <input type="number" id="netProductQty" value="1" min="1" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; margin-top: 4px;">
            </div>
          </div>
          
          <div style="margin-bottom: 12px;">
            <label style="font-size: 12px; color: #6b7280;">参考URL（任意）</label>
            <input type="text" id="netProductUrl" placeholder="https://..." style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; margin-top: 4px;">
          </div>
          
          <div>
            <label style="font-size: 12px; color: #6b7280;">販売元（任意）</label>
            <input type="text" id="netProductSeller" placeholder="例: Amazon、モノタロウ" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; margin-top: 4px;">
          </div>
        </div>
      </div>
      
      <div style="padding: 12px; border-top: 1px solid #e5e7eb;">
        <div style="display: flex; gap: 8px;">
          <button class="data-btn backup" style="flex: 1;" onclick="closeNetProductPicker()">キャンセル</button>
          <button class="save-btn" style="flex: 1; padding: 12px;" onclick="addNetProductToEstimate()">追加する</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- AI読み取り中ローディング -->
  <div id="netProductLoading" class="ocr-loading hidden">
    <div class="ocr-loading-content">
      <div class="loading-spinner"></div>
      <div id="netProductProgress">商品情報を読み取り中...</div>
    </div>
  </div>
  
  <!-- 出力選択モーダル -->
  <div id="outputModal" class="ocr-loading hidden" style="background: rgba(0,0,0,0.5);">
    <div style="background: white; border-radius: 16px; padding: 20px; width: 90%; max-width: 400px;">
      <h3 style="margin: 0 0 16px 0; font-size: 18px;">📤 出力形式を選択</h3>
      
      <div id="outputSummary" style="background: #f3f4f6; padding: 12px; border-radius: 8px; margin-bottom: 16px; font-size: 14px;">
        <!-- 見積もり概要 -->
      </div>
      
      <div style="font-size: 12px; color: #6b7280; margin-bottom: 8px; font-weight: 500;">📄 PDF</div>
      <div style="display: flex; gap: 8px; margin-bottom: 16px;">
        <button class="output-btn-mini" onclick="exportEstimatePDF('download')">
          <span>💾</span>
          <span>保存</span>
        </button>
        <button class="output-btn-mini" onclick="exportEstimatePDF('print')">
          <span>🖨️</span>
          <span>印刷</span>
        </button>
        <button class="output-btn-mini" onclick="exportEstimatePDF('share')">
          <span>📤</span>
          <span>共有</span>
        </button>
      </div>
      
      <div style="font-size: 12px; color: #6b7280; margin-bottom: 8px; font-weight: 500;">📊 Excel</div>
      <div style="display: flex; gap: 8px; margin-bottom: 16px;">
        <button class="output-btn-mini" onclick="exportEstimateExcel()">
          <span>💾</span>
          <span>保存</span>
        </button>
      </div>
      
      <button class="data-btn backup" style="width: 100%; margin-top: 8px;" onclick="closeOutputModal()">キャンセル</button>
    </div>
  </div>

